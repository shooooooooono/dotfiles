# =================================================
#                  tmux auto-start
# =================================================

# Auto-start tmux if:
# - tmux is installed
# - not already in a tmux session
# - not in WezTerm (uses its own multiplexer)
# - not via SSH (handled by .ssh/config RemoteCommand)
if command -v tmux &> /dev/null && [ -z "$TMUX" ] && [ "$TERM_PROGRAM" != "WezTerm" ] && [ -z "$SSH_TTY" ]; then
  tmux attach -t main || tmux new -s main
fi

# =================================================
#                     prompt
# =================================================

eval "$(starship init zsh)"

# =================================================
#                      env
# =================================================

export EDITOR=nvim
export HISTSIZE=1000
export SAVEHIST=100000

# =================================================
#                     option
# =================================================

setopt hist_ignore_dups
setopt EXTENDED_HISTORY

# vi mode
bindkey -v
KEYTIMEOUT=1

# =================================================
#                    functions
# =================================================

# git checkout
gcb() {
  local branches branch
  branches=$(git --no-pager branch -vv) &&
  branch=$(echo "$branches" | fzf +m) &&
  git checkout $(echo "$branch" | awk '{print $1}')
}

# kill process
pskill() {
  local pid
  pid=$(ps -ef | sed 1d | fzf -m | awk '{print $2}')
  if [ -n "$pid" ]; then
    echo $pid | xargs kill -${1:-9}
  fi
}

# repeat history
his() {
  print -z $( ([ -n "$ZSH_NAME" ] && fc -l 1 || history) | fzf +s --tac | sed -E 's/ *[0-9]*\*? *//' | sed -E 's/\\/\\\\/g')
}

# =================================================
#                      alias
# =================================================

{{- if eq .chezmoi.os "darwin" }}
alias ls='eza --icons'
{{- else }}
alias ls='eza --icons'
{{- end }}
alias ll='eza -l --icons --git'
alias la='eza -la --icons --git'
alias tree='eza --tree --icons'
alias cat='bat'
alias grep='rg'
alias find='fd'
alias du='dust'
alias ps='procs'

# ghq + fzf: select repository and cd
ghf() {
  local dir
  dir=$(ghq list -p | fzf) || return 0
  [ -n "$dir" ] && cd "$dir"
}


# =================================================
#                     manager
# =================================================

export PATH="$HOME/.local/bin:$PATH"

# asdf
{{- if eq .chezmoi.os "darwin" }}
[ -f "$(brew --prefix asdf)/libexec/asdf.sh" ] && . "$(brew --prefix asdf)/libexec/asdf.sh"
{{- else }}
[ -d "${ASDF_DATA_DIR:-$HOME/.asdf}" ] && export PATH="${ASDF_DATA_DIR:-$HOME/.asdf}/bin:${ASDF_DATA_DIR:-$HOME/.asdf}/shims:$PATH"
{{- end }}

# append completions to fpath
fpath=(${ASDF_DATA_DIR:-$HOME/.asdf}/completions $fpath)
# initialise completions with ZSH's compinit
autoload -Uz compinit && compinit

# zsh-autocomplete settings (before loading)
zstyle ':autocomplete:*' min-delay 0.5
zstyle ':autocomplete:*' async yes

# sheldon
eval "$(sheldon source)"

# zoxide (smart cd)
eval "$(zoxide init zsh --cmd cd)"

# Edit command line in nvim (Ctrl+e)
autoload -Uz edit-command-line
zle -N edit-command-line
bindkey '^e' edit-command-line

# =================================================
#                  chezmoi check
# =================================================

if ! command -v chezmoi &> /dev/null; then
  echo "⚠ chezmoi: not installed"
else
  if [[ -n "$(chezmoi diff 2>/dev/null)" ]]; then
    echo "⚠ chezmoi: diff detected. Run 'chezmoi apply'"
  fi
  _chezmoi_src="$(chezmoi source-path)"
  _ahead=$(git -C "$_chezmoi_src" rev-list --count origin/main..HEAD 2>/dev/null)
  _behind=$(git -C "$_chezmoi_src" rev-list --count HEAD..origin/main 2>/dev/null)
  [[ "$_ahead" -gt 0 ]] && echo "⚠ chezmoi: $_ahead commit(s) to push"
  [[ "$_behind" -gt 0 ]] && echo "⚠ chezmoi: $_behind commit(s) to pull"
fi

# =================================================
#                   custom zshrc
# =================================================

[ -f ~/.zshrc.local ] && source ~/.zshrc.local
